//@flow

import {GelfStream, bunyanToGelf} from 'gelf-stream';

// for some reason the log is being passed as JSON string, so it needs to be parsed first.
const bunyanToGelfFix = (log) => {
  const _log = typeof log === 'string' ? JSON.parse(log) : log;

  return bunyanToGelf(_log);
};

export default function logStreams(): Array<any> {
  const streams = [
    {
      stream: process.stdout,
    },
  ];

  if (process.env.GRAYLOG_SERVER_HOST || process.env.GRAYLOG_SERVER_PORT) {
    const {
      GRAYLOG_SERVER_HOST: host = 'localhost',
      GRAYLOG_SERVER_PORT: port = 5555,
    } =  process.env;

    const options = {
      map: bunyanToGelfFix,
    };

    const stream = new GelfStream(host, port, options);
    streams.push({
      stream
    });
  }

  return streams;
}
